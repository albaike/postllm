name: Test package release

on:
  push:
    branches:
      - master

jobs:
    test:
      name: test postgres extension
      runs-on: ubuntu-latest
      # Specifying a GitHub environment is optional, but strongly encouraged
      environment: release
      permissions:
        # IMPORTANT: this permission is mandatory for trusted publishing
        id-token: write
      steps:
        - name: Checkout code
          uses: actions/checkout@v2

        - name: Set up Python
          uses: actions/setup-python@v2
          with:
            python-version: 3.8

        - name: install
          run: |
            sudo apt install -y libxslt1-dev libxslt1.1 libxml2 libxml2-dev postgresql-16 postgresql-server-dev-16
            python -m pip install --upgrade pip
            pip install pstk

        - name: build
          run: make

        - name: test
          run: pstk --extension --schema-path=postxml--1.0.sql . test